```{r}
library(tidyverse)
```

```{r}
mbio.map <- readRDS("../Data/mbio_map.RDS") %>% 
  mutate(Compartment = fct_recode(Compartment,
         "Rhizosphere" = "RS",
         "Endosphere" = "ES"),
         Soil = fct_recode(Soil,
                           "Davis" = "D",
                           "Arbuckle" = "A",
                           "Biggs" = "B")) 
msys.map <- readRDS("../Data/msys_map.RDS")

meta.map <- rbind(select(mbio.map, SampleID, Compartment, Treatment, Soil) %>% mutate(Experiment = "mBio"),
                  select(msys.map, SampleID, Compartment) %>% mutate(Treatment = "WC", Soil = "Arkansas", Experiment = "mSys"))


otu <- readRDS("../Data/otu_meta.RDS")
row.names(otu) <- otu$OTU_ID 
otu <- otu[,-1]
otu[1:5, 1:5]

tax <- readRDS("../Data/tax.RDS")
tax <- classify_organelle(tax)
organelle.id <- filter(tax, Assignment != "Microbial")$OTU_ID

otu <- otu[!row.names(otu) %in% organelle.id,]

```

```{r}
tidy.otu <- otu %>% 
  tidy_otu()

tidy.otu
```

```{r}
drought.p <- tidy.otu %>% 
  inner_join(mbio.map, by = "SampleID") %>% 
  group_by(SampleID) %>% 
  mutate(RelAb = Count/sum(Count)) %>% 
  filter(OTU_ID == "1037355") %>% 
  filter(Compartment %in% c("Rhizosphere", "Endosphere")) %>% 
  mutate(Compartment = fct_relevel(Compartment, "Rhizosphere", "Endosphere")) %>% 
  filter(Compartment != "Bulk Soil") %>% 
  ggplot(aes(Treatment, RelAb, color = Treatment)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_color_manual(values = trt.pal[c(3,1)]) +
  ylab("Relative abundance (log10)") +
  facet_grid(. ~ Compartment + Soil) +
  theme_classic() +
  theme(text = element_text(size = 15),
        legend.position = "none",
        panel.border = element_blank())

drought.p
```

```{r}
n.samples <- meta.map %>% 
  group_by(Experiment, Compartment, Soil) %>% 
  summarise(nSamples = n())

oc.ab <- tidy.otu %>% 
  group_by(SampleID) %>% 
  mutate(RelAb = Count/sum(Count)) %>% 
  inner_join(meta.map) %>% 
  filter(Compartment %in% c("Rhizosphere", "Endosphere")) %>% 
  group_by(Experiment, Compartment, Soil, OTU_ID) %>% 
  summarise(MeanRelAb = mean(RelAb),
            Occupancy = sum(Count > 0)) %>% 
  ungroup() %>% 
  inner_join(n.samples, by = c("Experiment", "Compartment", "Soil")) %>% 
  mutate(OccupancyPct = Occupancy/nSamples)

oc.ab.p <- oc.ab %>% 
  filter(Occupancy > 0) %>% 
  ggplot(aes(MeanRelAb, OccupancyPct)) +
  geom_point(shape = 1, color = "gray25", alpha = 0.5) +
  geom_point(data = filter(oc.ab, OTU_ID == "1037355"), shape = 21, fill = phy.pal[3], color = "black", size = 3, stroke = 1) +
   scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  xlab("Mean relative\nabundance (log10)") +
  ylab("Occupancy (% samples)") +
  facet_grid(Compartment ~ Soil) +
  theme_classic() +
  theme(text = element_text(size = 15), 
        legend.position = "bottom",
        legend.title = element_blank())

oc.ab.p
```

```{r}
oc.ab %>% filter(OTU_ID == "1037355")
```

```{r}
cowplot::plot_grid(oc.ab.p, drought.p, nrow = 2,
                   labels = c("A", "B"), label_size = 20)
```

