Load libraries
```{r}
source("../General/rmb_functions.R")
source("../General/parameters.R")
library(vegan)
library(broom)
library(contrast)
library(cowplot)
library(ggConvexHull)
library(tidyverse)
```

Load data
```{r}
wuf <- readRDS("../Data/wuf.RDS")
map <- readRDS("../Data/drought_map.RDS")
```

Remove samples used to train RF model
Generate a column that treats time point as a discrete variable rather than continuous (relevant for testing the effect of treatment at each time point)
```{r}
map <- filter(map, Treatment2 != "WC_TRN")
map$TimeFctr <- as.factor(map$Time)
```

PERMANOVA
```{r}
wuf <- wuf[match(map$SampleID, rownames(wuf)), match(map$SampleID, colnames(wuf))]
pmanova <- adonis(as.dist(wuf) ~ Compartment * as.factor(Time) * Treatment, strata = as.factor(map$Row),  data = map)
pmanova
```

PCoA
```{r}
pcoa.axes <- pcoa_axes(wuf, map)
pcoa.eig <- pcoa_eigval(wuf, map)

all.pcoa.p <- pcoa.axes %>% 
  mutate(Compartment = fct_recode(Compartment,
                                  "Rhizosphere" = "RS",
                                  "Endosphere" = "ES")) %>% 
  mutate(Compartment = fct_relevel(Compartment, "Rhizosphere")) %>% 
  ggplot(aes(Axis.1, Axis.2)) +
  geom_point(aes(color = Compartment), size = 2, shape = 16) +
  xlab(paste("PCo1 (", pcoa.eig$Eigval[1], "%)", sep = "")) +
  ylab(paste("PCo2 (", pcoa.eig$Eigval[2], "%)", sep = "")) +
  scale_color_manual(values = cmp.pal) +
  theme_classic() +
  theme(text = element_text(size = 15),
        legend.position = "top")

all.pcoa.p
```

Within Compartment Distance
```{r}
dist.tidy <- wuf %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  mutate(SampleID.x = row.names(.)) %>% 
  gather(key = "SampleID.y", value = "Distance", -SampleID.x) %>% 
  filter(!is.na(Distance)) %>% 
  filter(Distance > 0) %>% 
  inner_join(select(map, SampleID, Compartment, Treatment, Time, CollectionDate, Age, WaterStatus), by = c("SampleID.x" = "SampleID")) %>% 
  inner_join(select(map, SampleID, Compartment, Treatment, Time, CollectionDate, Age, WaterStatus), by = c("SampleID.y" = "SampleID"))

dist.within <- dist.tidy %>% 
  filter(Compartment.x == Compartment.y) %>% 
  filter(Treatment.x == Treatment.y) %>% 
  filter(Time.x == Time.y)
  
cmp.box <- dist.within %>% 
  mutate(Compartment = fct_relevel(Compartment.x, "RS")) %>% 
  mutate(Compartment = fct_recode(Compartment, Rhizosphere = "RS", Endosphere = "ES")) %>% 
  ggplot(aes(Compartment, Distance, color = Compartment)) +
  geom_boxplot(size = 1) +
  geom_rug() +
  ylab("Within-Compartment\nDistance") +
  xlab("Compartment") +
  scale_color_manual(values = cmp.pal) +
  theme_classic() +
  theme(text = element_text(size = 15),
        legend.position = "top")

cmp.box
```

```{r}
plot_grid(all.pcoa.p,
          cmp.box,
          nrow = 1,
          align = "v",
          labels = c("A", "B"),
          label_size = 20)
```

Subset rhizosphere and endosphere datasets
```{r}
wuf <- as.matrix(wuf)

rs.map <- filter(map, Compartment == "RS")
rs.wuf <- wuf[match(rs.map$SampleID, row.names(wuf)), match(rs.map$SampleID, colnames(wuf))]

es.map <- filter(map, Compartment == "ES")
es.wuf <- wuf[match(es.map$SampleID, row.names(wuf)), match(es.map$SampleID, colnames(wuf))]
```

PERMANOVA per compartment
```{r}
rs.pmanova <- adonis(as.dist(rs.wuf) ~ as.factor(Time) * Treatment, strata = rs.map$Row,  data = rs.map)
rs.pmanova

es.pmanova <- adonis(as.dist(es.wuf) ~ as.factor(Time) * Treatment, strata = es.map$Row,  data = es.map)
es.pmanova
```
  
PCoA per compartment
```{r}
rs.pcoa.axes <- pcoa_axes(rs.wuf, rs.map)
rs.pcoa.eig <- pcoa_eigval(rs.wuf, rs.map)

es.pcoa.axes <- pcoa_axes(es.wuf, es.map)
es.pcoa.eig <- pcoa_eigval(es.wuf, es.map)
```

Plot PCoA
```{r}
rs.pc.time <- rs.pcoa.axes %>% 
  ggplot(aes(Axis.1, Axis.2, color = Age)) +
  geom_point(size = 2) +
  scale_color_viridis_c(name = "Plant Age\n(days)") +
  xlab(paste("PCo1 (", rs.pcoa.eig$Eigval[1], "%)", sep = "")) +
  ylab(paste("PCo2 (", rs.pcoa.eig$Eigval[2], "%)", sep = "")) +
  theme_classic() +
  theme(text = element_text(size = 15),
        legend.position = "top",
        legend.title.align = 1)

rs.pc.trt <- rs.pcoa.axes %>% 
  mutate(Treatment = fct_recode(Treatment,
                                "DS1" = "D1",
                                "DS2" = "D2",
                                "DS3" = "D3")) %>% 
  mutate(Treatment = fct_relevel(Treatment, "WC")) %>% 
  ggplot(aes(Axis.1, Axis.2, color = Treatment)) +
  geom_point(size = 2) +
  scale_color_manual(values = trt.pal,
                     guide = guide_legend(title.position = "top",
                                          title.hjust = 0.5)) +
  xlab(paste("PCo1 (", rs.pcoa.eig$Eigval[1], "%)", sep = "")) +
  ylab(paste("PCo2 (", rs.pcoa.eig$Eigval[2], "%)", sep = "")) +
  theme_classic() +
  theme(text = element_text(size = 15),
        legend.position = "none")

es.pc.time <- es.pcoa.axes %>% 
  ggplot(aes(Axis.1, Axis.2, color = Age)) +
  geom_point(size = 2) +
  scale_color_viridis_c() +
  xlab(paste("PCo1 (", es.pcoa.eig$Eigval[1], "%)", sep = "")) +
  ylab(paste("PCo2 (", es.pcoa.eig$Eigval[2], "%)", sep = "")) +
  theme_classic() +
  theme(text = element_text(size = 15),
        legend.position = "top")

es.pc.trt <- es.pcoa.axes %>% 
  ggplot(aes(Axis.1, Axis.2, color = Treatment)) +
  geom_point(size = 2) +
  scale_color_manual(values = trt.pal) +
  xlab(paste("PCo1 (", es.pcoa.eig$Eigval[1], "%)", sep = "")) +
  ylab(paste("PCo2 (", es.pcoa.eig$Eigval[2], "%)", sep = "")) +
  theme_classic() +
  theme(text = element_text(size = 15),
        legend.position = "right")
```

```{r}
rs.expanded <- rs.pcoa.axes %>% 
  ggplot(aes(Axis.1, Axis.2, color = Treatment)) +
  geom_point() +
  geom_convexhull(aes(fill = Treatment), alpha = 0.7) +
  xlab(paste("PCo1 (", rs.pcoa.eig$Eigval[1], "%)", sep = "")) +
  ylab(paste("PCo2 (", rs.pcoa.eig$Eigval[2], "%)", sep = "")) +
  scale_color_manual(values = trt.pal) +
  scale_fill_manual(values = trt.pal) +
  facet_wrap(~ Age, nrow = 2) +
  theme_bw() +
  theme(legend.position = c(0.9,0.15),
        text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, hjust = 1))

es.expanded <- es.pcoa.axes %>% 
  ggplot(aes(Axis.1, Axis.2, color = Treatment)) +
  geom_point() +
  geom_convexhull(aes(fill = Treatment), alpha = 0.7) +
  xlab(paste("PCo1 (", es.pcoa.eig$Eigval[1], "%)", sep = "")) +
  ylab(paste("PCo2 (", es.pcoa.eig$Eigval[2], "%)", sep = "")) +
  scale_color_manual(values = trt.pal) +
  scale_fill_manual(values = trt.pal) +
  facet_wrap(~ Age, nrow = 2) +
  theme_bw() +
  theme(legend.position = c(0.9,0.15),
        text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
supp.legend <- plot_grid(get_legend(all.pcoa.p), get_legend(rs.pc.time))

supp.top <- plot_grid(all.pcoa.p + theme(legend.position = "none"), cmp.box + theme(legend.position = "none"), 
                      rs.pc.time + theme(legend.position = "none"), es.pc.time + theme(legend.position = "none"),
          nrow = 1,
          align = "vh",
          axis = "l",
          rel_widths = c(3,3,3,3),
          labels = c("A","B", "C", "D"),
          label_size = 20)

supp.bottom <- plot_grid(rs.expanded, es.expanded,
          nrow = 2,
          align = "vh",
          axis = "l",
          labels = c("E", "F"),
          label_size = 20)

plot_grid(supp.legend, supp.top, supp.bottom,
          nrow = 3,
          rel_heights = c(1,2,5))
```

Functions to test the effect of drought treatment on principal coordinates
```{r}
run_lmm <- function(df) {
  lmerTest::lmer(value ~ Treatment * TimeFctr + (1|Row), data = df)
}

run_anova <- function(fit) {
  anova(fit) %>% tidy()
}

get_contrasts <- function(fit) {
  emmeans::emmeans(fit, specs = trt.vs.ctrl ~ Treatment|TimeFctr, adjust = "none") %>% 
    .$contrasts %>% 
    as.data.frame() %>% 
    separate(contrast, c("Treatment", "Control")) %>% 
    rename("Time" = "TimeFctr") %>% 
    mutate(Time = as.integer(Time))
}
```

Run LMMs
```{r}
rs.pcoa.lmm <- rs.pcoa.axes %>%
  select(Axis.1:Axis.5, SampleID:TimeFctr) %>%
  gather(key = "Axis", value = "value", Axis.1:Axis.5) %>%
  group_by(Axis) %>%
  nest() %>%
  mutate(lmm = map(data, run_lmm),
         anova = map(lmm, run_anova),
         contrasts = map(lmm, get_contrasts))

es.pcoa.lmm <- es.pcoa.axes %>%
  select(Axis.1:Axis.5, SampleID:TimeFctr) %>%
  gather(key = "Axis", value = "value", Axis.1:Axis.5) %>%
  group_by(Axis) %>%
  nest() %>%
  mutate(lmm = map(data, run_lmm),
         anova = map(lmm, run_anova),
         contrasts = map(lmm, get_contrasts))
```

Make a data frame to transform time points to ages
```{r}
time.age <- map %>% group_by(Time, Age) %>% count() %>% select(-n)
```


```{r}
rs.means <- rs.pcoa.axes %>% 
  group_by(Treatment, Age) %>% 
  mutate(Mean = mean(Axis.1)) %>% 
  ungroup()

rs.pc <- rs.pcoa.axes %>% 
  ggplot(aes(Age, Axis.1)) +
  geom_vline(xintercept = ws.line, linetype = 3, color = "gray20", size = 0.5) +
  geom_point(aes(color = Treatment), alpha = 1, shape = 1, size = 2) +
  geom_point(aes(0,0), alpha = 0) +
  geom_line(data = rs.means, aes(y = Mean, color = Treatment), size = 1) +
  xlab("Plant age (days)") +
  ylab(paste("Rhizopshere\nPCo1 (", rs.pcoa.eig$Eigval[1], "%)", sep = "")) +
  scale_fill_manual(values = trt.pal) +
  scale_color_manual(values = trt.pal) +
  scale_x_continuous(breaks = seq(0,140,20)) +
  theme_classic() +
  theme(legend.position = "none",
        text = element_text(size = 15))

rs.sig <- rs.pcoa.lmm %>% 
  unnest(contrasts) %>% 
  filter(Axis == "Axis.1") %>% 
  ungroup() %>% 
  mutate(p.adj = p.adjust(p.value, method = "fdr")) %>% 
  inner_join(time.age, by = "Time") %>% 
  ggplot(aes(Age, Treatment)) +
  geom_point(aes(color = Treatment, alpha = p.adj < 0.05), shape = "*", size = 7) +
  geom_point(aes(0,1), alpha = 0) +
  scale_y_discrete(limits = c("D3", "D2", "D1")) +
  scale_x_continuous(breaks = seq(0,140,20)) +
  scale_color_manual(values = trt.pal[-1]) +
  scale_alpha_manual(values = c(0,1)) +
  theme_void() +
  theme(legend.position = "none")

rs.plot <- plot_grid(rs.sig, rs.pc, ncol = 1, rel_heights = c(3,17), align = "v")

rs.plot
```

```{r}
es.means <- es.pcoa.axes %>% 
  group_by(Treatment, Age) %>% 
  mutate(Mean = mean(Axis.1)) %>% 
  ungroup()

es.pc <- es.pcoa.axes %>%  
  ggplot(aes(Age, Axis.1)) +
  geom_vline(xintercept = ws.line, linetype = 3, color = "gray20", size = 0.5) +
  geom_point(aes(color = Treatment), shape = 1, size = 2, alpha = 1) +
  geom_point(aes(0,0), alpha = 0) +
  geom_line(data = es.means, aes(y = Mean, color = Treatment), size = 1) +
  xlab("Plant age (days)") +
  ylab(paste("Endosphere\nPCo1 (", es.pcoa.eig$Eigval[1], "%)", sep = "")) +
  scale_fill_manual(values = trt.pal) +
  scale_color_manual(values = trt.pal) +
  scale_x_continuous(breaks = seq(0,140,20)) +
  theme_classic() +
  theme(legend.position = "none",
        text = element_text(size = 15))


es.sig <- es.pcoa.lmm %>% 
  unnest(contrasts) %>% 
  filter(Axis == "Axis.1") %>% 
  ungroup() %>% 
  mutate(p.adj = p.adjust(p.value, method = "fdr")) %>% 
  inner_join(time.age, by = "Time") %>% 
  ggplot(aes(Age, Treatment)) +
  geom_point(aes(color = Treatment, alpha = p.adj < 0.05), shape = "*", size = 7) +
  geom_point(aes(0,1), alpha = 0) +
  scale_y_discrete(limits = c("D3", "D2", "D1")) +
  scale_x_continuous(breaks = seq(0,140,20)) +
  scale_color_manual(values = trt.pal[-1]) +
  scale_alpha_manual(values = c(0,1)) +
  theme_void() +
  theme(legend.position = "none")

es.plot <- plot_grid(es.sig, es.pc, ncol = 1, rel_heights = c(3,17), align = "v")

es.plot
```

```{r}
soil <- map %>% 
  filter(Treatment2 != "WC_TRN") %>% 
  filter(Compartment == "RS") %>% 
  mutate(TimeFctr = as.factor(Time))
```

Run an anova to check for significant effects
```{r}
soil.lmm <- lmerTest::lmer(PercentMoisture ~ Treatment * TimeFctr + (1|Row), data = soil)

soil.aov <- anova(soil.lmm) %>% 
  tidy()

soil.contrasts <- emmeans::emmeans(soil.lmm, specs = trt.vs.ctrl ~ Treatment|TimeFctr, adjust = "none") %>% 
  .$contrasts %>% 
  as.data.frame() %>% 
  separate(contrast, c("Treatment", "Control")) %>% 
  rename("Time" = "TimeFctr") %>% 
  mutate(Time = as.integer(Time))

```

```{r}
soil.means <- map %>% 
  group_by(Age, Treatment, WaterStatus) %>% 
  summarise(MeanPM = mean(PercentMoisture))

soil.p <- soil %>% 
  ggplot(aes(Age, PercentMoisture)) +
  geom_vline(xintercept = ws.line, linetype = 3, color = "gray20", size = 0.5) +
  geom_point(aes(color = Treatment), shape = 1, size = 2, alpha = 1) +
  geom_point(aes(0,20), alpha = 0) +
  geom_line(data = soil.means, aes(Age, MeanPM, color = Treatment), size= 1) +
  scale_color_manual(values = trt.pal) +
  scale_x_continuous(breaks = seq(0,140,20)) +
  scale_shape_manual(values = ws.shp) +
  ylab("Soil moisture\n(% weight)") +
  xlab("Plant age (days)") +
  theme_classic() +
  theme(legend.position = "none",
        text = element_text(size = 15))

soil.p

sig.p <- soil.contrasts %>% 
  ungroup() %>% 
  mutate(p.adj = p.adjust(p.value, method = "fdr")) %>% 
  inner_join(time.age, by = "Time") %>% 
  ggplot(aes(Age, Treatment)) +
  geom_point(aes(color = Treatment, alpha = p.adj < 0.05), shape = "*", size = 7) +
  geom_point(aes(0,1), alpha = 0) +
  scale_y_discrete(limits = c("D3", "D2", "D1")) +
  scale_x_continuous(breaks = seq(0,140,20)) +
  scale_color_manual(values = trt.pal[-1]) +
  scale_alpha_manual(values = c(0,1)) +
  xlab("Plant age (days)") +
  #xlim(0,NA) +
  theme_void() +
  theme(legend.position = "none") 

sig.p

soil.plot <- plot_grid(sig.p, soil.p, ncol = 1, rel_heights = c(3,17), align = "v")
soil.plot
```

```{r}
xpt.ds <-  map %>% 
  mutate(Treatment = case_when(Treatment == "WC" ~ "WC",
                                    Treatment == "D1" ~ "DS1",
                                    Treatment == "D2" ~ "DS2",
                                    Treatment == "D3" ~ "DS3")) %>% 
  mutate(Treatment = fct_relevel(Treatment, "WC")) 

xpt.p <- xpt.ds %>% 
  filter(WaterStatus != "S") %>% 
  ggplot(aes(PrevAge, Treatment)) +
  geom_segment(aes(xend = Age, yend = Treatment, color = Treatment), size = 3, linetype = 1) +
  geom_segment(data = filter(xpt.ds, WaterStatus == "S"), aes( xend = Age, yend = Treatment, color = Treatment), linetype = 2) +
  geom_point(aes(Age, 4.5), shape = 6, size = 2) +
  geom_vline(xintercept = ws.line, linetype = 3, color = "gray20", size = 0.5) +
  xlab("Plant age (days)") +
  scale_color_manual(values = trt.pal) +
  scale_y_discrete(limits = c("DS3", "DS2", "DS1", "WC")) +
  scale_x_continuous(breaks = seq(0,140,20),
                     position = "bottom") +
  scale_linetype_manual(values = c(1,3)) +
  theme_classic() +
  theme(text = element_text(size = 15),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        legend.position = "none")


xpt.p
```

```{r}
#386:1073

plot_grid(xpt.p,
          sig.p, soil.p, 
          rs.sig, rs.pc, 
          es.sig,es.pc,
          ncol = 1,
          align = "v",
          rel_heights = c(10,
                          3,17,
                          3,17,
                          3,17),
          labels = c("A", "B", NA, "C", NA, "D", NA),
          label_size = 20)
```

```{r}
whole.map <- readRDS("../Data/drought_map.RDS")

tubs.p <- whole.map %>% 
  mutate(Treatment = str_replace(Treatment, "D", "DS")) %>% 
  mutate(Treatment = fct_relevel(Treatment, "WC")) %>% 
  mutate(Treatment2 = str_replace(Treatment2, "D", "DS")) %>% 
  group_by(Column, Row, Treatment, Treatment2) %>%
  count() %>% 
  ggplot(aes(Column, Row, fill = Treatment)) +
  geom_tile(color = "white", size = 2) +
  geom_text(aes(label = Treatment2), color = "white", size = 5) +
  scale_fill_manual(values = trt.pal) +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        text = element_text(size = 20),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank())

tubs.p
```

```{r}
rs.anova <- rs.pcoa.lmm %>% 
  unnest(anova) %>% 
  filter(Axis == "Axis.1") %>% 
  ungroup() %>% 
  select(term:p.value)

es.anova <- es.pcoa.lmm %>% 
  unnest(anova) %>% 
  filter(Axis == "Axis.1") %>% 
  ungroup() %>% 
  select(term:p.value)

soil.aov

rs.contrasts <- rs.pcoa.lmm %>% 
  unnest(contrasts) %>% 
  filter(Axis == "Axis.1") %>% 
  select(Treatment:p.value) %>% 
  ungroup() %>% 
  mutate(p.adj = p.adjust(p.value, method = "fdr")) %>% 
  mutate(Contrast = paste(Treatment, Control, sep = "-")) %>% 
  select(Contrast, Time:p.adj)

es.contrasts <-  es.pcoa.lmm %>% 
  unnest(contrasts) %>% 
  filter(Axis == "Axis.1") %>% 
  select(Treatment:p.value) %>% 
  ungroup() %>% 
  mutate(p.adj = p.adjust(p.value, method = "fdr")) %>% 
  mutate(Contrast = paste(Treatment, Control, sep = "-")) %>% 
  select(Contrast, Time:p.adj)

soil.contrasts <- soil.contrasts %>% ungroup() %>% 
  mutate(p.adj = p.adjust(p.value, method = "fdr")) %>% 
  mutate(Contrast = paste(Treatment, Control, sep = "-")) %>% 
  select(Contrast, Time:p.adj)

write.table(rs.anova, "../Tables/rs_pcoa_anova.tsv", quote = F, row.names = F, sep = "\t")
write.table(es.anova, "../Tables/es_pcoa_anova.tsv", quote = F, row.names = F, sep = "\t")
write.table(soil.aov, "../Tables/soil_anova.tsv", quote = F, row.names = F, sep = "\t")
write.table(rs.contrasts, "../Tables/rs_pcoa_cntr.tsv", quote = F, row.names = F, sep = "\t")
write.table(es.contrasts, "../Tables/es_pcoa_cntr.tsv", quote = F, row.names = F, sep = "\t")
write.table(soil.contrasts, "../Tables/soil_cntr.tsv", quote = F, row.names = F, sep = "\t")
```

